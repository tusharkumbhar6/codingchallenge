from ldap3 import Server, Connection, NTLM, SUBTREE, ALL

def find_owner_dn(conn, base_dn, owner_name):
    conn.search(
        search_base=base_dn,
        search_filter=f"(&(objectClass=user)(displayName={owner_name}))",
        search_scope=SUBTREE,
        attributes=["distinguishedName"]
    )
    if conn.entries:
        return conn.entries[0].distinguishedName.value
    return None


def get_fids_by_owner(conn, base_dn, owner_dn, owner_field="managedBy"):
    search_filter = f"(&(objectClass=user)({owner_field}={owner_dn}))"

    conn.search(
        search_base=base_dn,
        search_filter=search_filter,
        search_scope=SUBTREE,
        attributes=[
            "sAMAccountName", "displayName", "department",
            "mail", "manager", "description", "distinguishedName"
        ]
    )

    results = []
    for entry in conn.entries:
        results.append({
            "fid": entry.sAMAccountName.value,
            "name": entry.displayName.value,
            "department": entry.department.value,
            "email": entry.mail.value,
            "manager": entry.manager.value,
            "description": entry.description.value if "description" in entry else None,
            "dn": entry.distinguishedName.value
        })

    return results


# ---------------------- MAIN LOGIC ----------------------

server = Server("ldap://YOUR_SERVER", get_info=ALL)
conn = Connection(server, user="DOMAIN\\bindUser", password="xxxx", authentication=NTLM)
conn.bind()

base_dn = "DC=reg1,DC=org,DC=my_company,DC=com"

owner_dn = find_owner_dn(conn, base_dn, "Mr ABC")

if owner_dn:
    fids = get_fids_by_owner(conn, base_dn, owner_dn, owner_field="managedBy")
    for f in fids:
        print(f)
else:
    print("Owner Mr ABC not found")
